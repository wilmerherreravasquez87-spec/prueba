<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>EcÃ³nomos â€” Iglesia del Nazareno</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #C9A84C;
    --gold-light: #E8C97A;
    --gold-dark: #8B6914;
    --navy: #0D1B2A;
    --navy-mid: #1A2E45;
    --navy-light: #243B55;
    --cream: #F5F0E8;
    --cream-dark: #E8E0D0;
    --white: #FDFAF5;
    --red: #C0392B;
    --green: #1A6B3C;
    --text: #2C1810;
    --border: rgba(201,168,76,0.3);
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html { font-size: 16px; }

  body {
    font-family: 'Crimson Pro', serif;
    background: var(--navy);
    color: var(--cream);
    min-height: 100vh;
    min-height: 100dvh;
    overflow-x: hidden;
  }

  /* â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â• */
  #login-screen {
    position: fixed; inset: 0;
    background: radial-gradient(ellipse at 30% 40%, #1A2E45 0%, #0D1B2A 60%, #060e18 100%);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
    padding: 20px;
  }

  .login-box {
    background: var(--navy-light);
    border: 1px solid var(--gold);
    border-radius: 12px;
    padding: 40px 28px;
    width: 100%; max-width: 380px;
    text-align: center;
    box-shadow: 0 0 60px rgba(201,168,76,0.15), 0 20px 60px rgba(0,0,0,0.6);
    animation: fadeIn 0.6s ease;
  }

  @keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

  .login-cross { font-size: 44px; margin-bottom: 10px; }

  .login-box h2 {
    font-family: 'Cinzel', serif;
    color: var(--gold-light);
    font-size: 1.15rem;
    margin-bottom: 4px;
    letter-spacing: 1px;
  }

  .login-box > p {
    font-size: 0.78rem;
    color: rgba(201,168,76,0.5);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 28px;
  }

  .login-box .form-group { text-align: left; margin-bottom: 14px; }
  .login-box input { width: 100%; padding: 12px 14px; }

  .btn-login {
    width: 100%; padding: 14px;
    background: var(--gold); color: var(--navy);
    border: none; border-radius: 6px;
    font-family: 'Cinzel', serif;
    font-size: 0.95rem; letter-spacing: 2px;
    cursor: pointer; margin-top: 8px;
    transition: background 0.2s;
    touch-action: manipulation;
  }
  .btn-login:hover, .btn-login:active { background: var(--gold-light); }

  .login-error { color: #E57373; font-size: 0.85rem; margin-top: 10px; display: none; }

  /* â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â• */
  header {
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 50%, var(--navy) 100%);
    border-bottom: 2px solid var(--gold);
    padding: 12px 16px;
    display: flex; align-items: center; gap: 10px;
    position: sticky; top: 0; z-index: 100;
    box-shadow: 0 4px 30px rgba(0,0,0,0.5);
  }

  .logo-circle {
    width: 40px; height: 40px;
    border: 2px solid var(--gold); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    background: radial-gradient(circle, var(--navy-light), var(--navy));
    flex-shrink: 0;
  }

  .header-text { flex: 1; min-width: 0; }
  .header-text h1 {
    font-family: 'Cinzel', serif;
    font-size: clamp(0.72rem, 2.8vw, 1rem);
    color: var(--gold-light); letter-spacing: 0.5px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .header-text p {
    font-size: 0.65rem; color: rgba(201,168,76,0.6);
    letter-spacing: 1.5px; text-transform: uppercase;
  }

  .user-badge {
    display: flex; align-items: center; gap: 5px;
    color: var(--gold-light); font-size: 0.8rem;
    cursor: pointer; padding: 7px 10px;
    border: 1px solid var(--border); border-radius: 4px;
    transition: all 0.2s; background: transparent;
    font-family: 'Crimson Pro', serif; white-space: nowrap;
    touch-action: manipulation;
  }
  .user-badge:hover, .user-badge:active { background: rgba(201,168,76,0.1); }

  /* â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â• */
  .main-content { padding: 16px 12px; max-width: 1200px; margin: 0 auto; }

  @media (min-width: 600px)  { .main-content { padding: 22px 20px; } }
  @media (min-width: 1024px) { .main-content { padding: 28px 30px; } }

  /* â•â•â•â•â•â•â•â•â•â• TYPOGRAPHY â•â•â•â•â•â•â•â•â•â• */
  .page-title {
    font-family: 'Cinzel', serif;
    font-size: clamp(1.15rem, 4vw, 1.55rem);
    color: var(--gold-light);
    margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 10px;
  }
  .page-subtitle {
    font-size: 0.82rem; color: rgba(201,168,76,0.6);
    margin-bottom: 18px; letter-spacing: 1px;
  }

  /* â•â•â•â•â•â•â•â•â•â• FORMS â•â•â•â•â•â•â•â•â•â• */
  .form-section {
    background: var(--navy-light); border: 1px solid var(--border);
    border-radius: 8px; padding: 16px 14px; margin-bottom: 16px;
  }
  @media (min-width: 600px) { .form-section { padding: 20px 22px; } }

  .form-section h3 {
    font-family: 'Cinzel', serif; color: var(--gold);
    font-size: 0.92rem; margin-bottom: 14px;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 185px), 1fr));
    gap: 10px; margin-bottom: 10px;
  }

  .form-group { display: flex; flex-direction: column; gap: 4px; }

  label {
    font-size: 0.72rem; color: rgba(201,168,76,0.7);
    letter-spacing: 1px; text-transform: uppercase;
  }

  input, select, textarea {
    background: var(--navy); border: 1px solid var(--border);
    border-radius: 4px; color: var(--cream);
    padding: 9px 10px; font-family: 'Crimson Pro', serif;
    font-size: 16px; /* prevents iOS zoom */
    outline: none; transition: border-color 0.2s; width: 100%;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--gold); box-shadow: 0 0 0 2px rgba(201,168,76,0.15);
  }
  select {
    -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='7' viewBox='0 0 10 7'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23C9A84C' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center;
    padding-right: 28px;
  }
  select option { background: var(--navy); }

  /* â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â• */
  .btn {
    padding: 10px 16px; border: none; border-radius: 4px;
    cursor: pointer; font-family: 'Cinzel', serif;
    font-size: 0.8rem; letter-spacing: 1px;
    transition: all 0.2s; touch-action: manipulation; white-space: nowrap;
  }
  .btn-gold { background: var(--gold); color: var(--navy); }
  .btn-gold:hover, .btn-gold:active { background: var(--gold-light); }
  .btn-outline { background: transparent; border: 1px solid var(--gold); color: var(--gold); }
  .btn-outline:hover, .btn-outline:active { background: rgba(201,168,76,0.1); }
  .btn-danger {
    background: var(--red); color: white; font-size: 0.75rem;
    padding: 6px 10px; border-radius: 4px; border: none;
    cursor: pointer; touch-action: manipulation;
  }
  .btn-sm { padding: 6px 12px; font-size: 0.73rem; }
  .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }

  /* â•â•â•â•â•â•â•â•â•â• TAB BAR â•â•â•â•â•â•â•â•â•â• */
  .tab-bar {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px; margin-bottom: 18px;
  }
  @media (min-width: 480px) { .tab-bar { grid-template-columns: repeat(4, auto); display: flex; flex-wrap: wrap; } }

  /* â•â•â•â•â•â•â•â•â•â• STAT CARDS â•â•â•â•â•â•â•â•â•â• */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px; margin-bottom: 16px;
  }
  @media (min-width: 560px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }

  .stat-card {
    background: linear-gradient(135deg, var(--navy-light), var(--navy-mid));
    border: 1px solid var(--border); border-radius: 8px;
    padding: 12px 8px; text-align: center;
  }
  .stat-card .s-icon { font-size: 16px; margin-bottom: 3px; }
  .stat-card .s-num  { font-family: 'Cinzel', serif; font-size: clamp(1rem, 2.5vw, 1.35rem); color: var(--gold-light); line-height: 1.1; }
  .stat-card .s-lbl  { font-size: 0.6rem; color: rgba(201,168,76,0.55); letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }

  /* â•â•â•â•â•â•â•â•â•â• TABLES â•â•â•â•â•â•â•â•â•â• */
  .table-wrap {
    background: var(--navy-light); border: 1px solid var(--border);
    border-radius: 8px; overflow: hidden; margin-bottom: 16px;
  }
  .table-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 14px; border-bottom: 1px solid var(--border);
    flex-wrap: wrap; gap: 6px;
  }
  .table-header h3 { font-family: 'Cinzel', serif; color: var(--gold); font-size: 0.85rem; }
  .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table { width: 100%; border-collapse: collapse; min-width: 420px; }
  th {
    background: rgba(201,168,76,0.08); padding: 9px 10px;
    text-align: left; font-family: 'Cinzel', serif;
    font-size: 0.66rem; color: var(--gold); letter-spacing: 1px;
    border-bottom: 1px solid var(--border); white-space: nowrap;
  }
  td {
    padding: 9px 10px; border-bottom: 1px solid rgba(201,168,76,0.07);
    font-size: 0.86rem; color: var(--cream); white-space: nowrap;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(201,168,76,0.05); }

  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 20px;
    font-size: 0.7rem; font-family: 'Cinzel', serif; letter-spacing: 0.5px;
  }
  .badge-gold { background: rgba(201,168,76,0.2); color: var(--gold-light); border: 1px solid var(--border); }
  .badge-blue { background: rgba(25,70,130,0.3); color: #90CAF9; border: 1px solid rgba(25,70,130,0.4); }

  /* â•â•â•â•â•â•â•â•â•â• ALERTS â•â•â•â•â•â•â•â•â•â• */
  .alert { padding: 9px 14px; border-radius: 6px; margin-bottom: 12px; font-size: 0.88rem; display: none; }
  .alert-success { background: rgba(26,107,60,0.2); border: 1px solid rgba(26,107,60,0.4); color: #4CAF7D; }
  .alert-error   { background: rgba(192,57,43,0.2); border: 1px solid rgba(192,57,43,0.4); color: #E57373; }

  /* â•â•â•â•â•â•â•â•â•â• SEARCH PANEL â•â•â•â•â•â•â•â•â•â• */
  .search-panel {
    background: var(--navy-light); border: 1px solid var(--border);
    border-radius: 8px; padding: 16px 14px; margin-bottom: 16px; position: relative;
  }
  @media (min-width: 600px) { .search-panel { padding: 20px 22px; } }

  .search-panel h3 { font-family: 'Cinzel', serif; color: var(--gold); font-size: 0.92rem; margin-bottom: 14px; }

  .search-fields {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }
  @media (min-width: 480px) { .search-fields { grid-template-columns: 1fr 120px 120px auto; align-items: flex-end; } }

  #buscar-sugerencias {
    position: absolute; left: 0; right: 0;
    background: var(--navy-light); border: 1px solid var(--gold);
    border-radius: 0 0 8px 8px; z-index: 200;
    max-height: 240px; overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    margin: 0 14px;
  }
  @media (min-width: 600px) { #buscar-sugerencias { margin: 0 22px; } }

  /* â•â•â•â•â•â•â•â•â•â• RANKING GRID â•â•â•â•â•â•â•â•â•â• */
  .ranking-grid { display: grid; grid-template-columns: 1fr; gap: 14px; margin-bottom: 14px; }
  @media (min-width: 640px) { .ranking-grid { grid-template-columns: 1fr 1fr; } }

  /* â•â•â•â•â•â•â•â•â•â• ECONOMO SECTION â•â•â•â•â•â•â•â•â•â• */
  .econ-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }

  /* â•â•â•â•â•â•â•â•â•â• TABLE FOOTER â•â•â•â•â•â•â•â•â•â• */
  .tbl-footer {
    padding: 9px 14px; border-top: 1px solid var(--border);
    display: flex; gap: 14px; flex-wrap: wrap;
  }
  .tbl-footer span { color: var(--gold); font-family: 'Cinzel', serif; font-size: 0.76rem; }

  /* â•â•â•â•â•â•â•â•â•â• FILTROS BAR â•â•â•â•â•â•â•â•â•â• */
  .filtros-bar {
    display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 12px;
  }
  .filtros-bar select { flex: 1; min-width: 140px; }

  /* â•â•â•â•â•â•â•â•â•â• SCROLLBAR â•â•â•â•â•â•â•â•â•â• */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: var(--navy); }
  ::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 3px; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-cross">âœ</div>
    <h2>Iglesia del Nazareno</h2>
    <p>EcÃ³nomos Â· MÃ³dulo 2026</p>
    <div class="form-group">
      <label>Usuario</label>
      <input type="text" id="login-user" placeholder="admin" autocomplete="username" inputmode="text">
    </div>
    <div class="form-group">
      <label>ContraseÃ±a</label>
      <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
             autocomplete="current-password" onkeydown="if(event.key==='Enter') doLogin()">
    </div>
    <button class="btn-login" onclick="doLogin()">INGRESAR</button>
    <div class="login-error" id="login-error">âš  Usuario o contraseÃ±a incorrectos</div>
    <div style="margin-top:18px;font-size:0.72rem;color:rgba(201,168,76,0.35)">
      Usuario: <strong style="color:rgba(201,168,76,0.5)">admin</strong> &nbsp;|&nbsp;
      ContraseÃ±a: <strong style="color:rgba(201,168,76,0.5)">1234</strong>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo-circle">âœ</div>
  <div class="header-text">
    <h1>Iglesia del Nazareno â€” Negropampa</h1>
    <p>MÃ³dulo EcÃ³nomos Â· 2026</p>
  </div>
  <button onclick="cerrarSesion()" class="user-badge">
    ğŸ‘¤ <span id="user-name">Admin</span> Â· Salir
  </button>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTENIDO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-content">

  <div class="page-title">EcÃ³nomos â€” Diezmos</div>
  <div class="page-subtitle">Control de diezmos dominicales Â· Responsabilidad de los EcÃ³nomos</div>

  <!-- EcÃ³nomos actuales -->
  <div style="margin-bottom:18px;">
    <div class="econ-header">
      <div style="font-family:'Cinzel',serif;font-size:0.76rem;color:var(--gold);letter-spacing:2px;text-transform:uppercase;">ğŸª™ EcÃ³nomos Actuales</div>
      <button class="btn btn-gold btn-sm" onclick="togglePanelEconomo()">âš™ï¸ Agregar / Editar</button>
    </div>
    <div id="econ-lista-cards" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;"></div>

    <div id="form-economo-panel" style="display:none;background:var(--navy-light);border:1px solid var(--gold);border-radius:8px;padding:16px 14px;margin-top:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="font-family:'Cinzel',serif;color:var(--gold);font-size:0.9rem;margin:0;">âš™ï¸ GestiÃ³n de EcÃ³nomos</h3>
        <button onclick="togglePanelEconomo()" style="background:none;border:none;color:var(--cream-dark);font-size:22px;cursor:pointer;padding:2px 6px;line-height:1;">âœ•</button>
      </div>
      <div id="alert-economo-form" class="alert alert-success"></div>
      <div style="margin-bottom:14px;">
        <div style="font-size:0.68rem;color:rgba(201,168,76,0.6);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Registrados</div>
        <div id="econ-crud-lista" style="display:flex;flex-direction:column;gap:5px;"></div>
      </div>
      <hr style="border-color:rgba(201,168,76,0.2);margin-bottom:12px;">
      <div id="form-economo-titulo" style="font-size:0.78rem;color:var(--gold-light);margin-bottom:8px;font-family:'Cinzel',serif;">Nuevo EcÃ³nomo</div>
      <input type="hidden" id="econ-edit-id">
      <div class="form-row">
        <div class="form-group"><label>Persona</label><select id="econ-add-persona"><option value="">-- Seleccionar --</option></select></div>
        <div class="form-group"><label>AÃ±o</label>
          <select id="econ-add-ano">
            <option value="2026">2026</option><option value="2025">2025</option><option value="2024">2024</option>
          </select>
        </div>
        <div class="form-group"><label>PerÃ­odo</label><input id="econ-add-periodo" placeholder="2025 - 2026"></div>
      </div>
      <div class="actions">
        <button class="btn btn-gold" onclick="guardarEconomo()">ğŸ’¾ Guardar</button>
        <button class="btn btn-outline" onclick="limpiarFormEconomo()">Nuevo</button>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tab-bar">
    <button id="dtab-btn-diezmos" class="btn-tab-green" onclick="showEconTab('diezmos')">ğŸ’° Registrar</button>
    <button id="dtab-btn-historial" class="btn btn-outline" onclick="showEconTab('historial')">ğŸ“‹ Historial</button>
    <button id="dtab-btn-ranking"   class="btn btn-outline" onclick="showEconTab('ranking')">ğŸ† Ranking</button>
  </div>

  <!-- â•â•â•â• TAB: REGISTRAR â•â•â•â• -->
  <div id="dtab-diezmos" style="display:none;">
    <div class="stats-grid">
      <div class="stat-card"><div class="s-icon">ğŸ“…</div><div class="s-num" id="dstat-domingos">0</div><div class="s-lbl">Domingos</div></div>
      <div class="stat-card"><div class="s-icon">ğŸ‘¥</div><div class="s-num" id="dstat-count">0</div><div class="s-lbl">Diezmos</div></div>
      <div class="stat-card"><div class="s-icon">ğŸ’°</div><div class="s-num" id="dstat-total">S/0</div><div class="s-lbl">Total</div></div>
      <div class="stat-card"><div class="s-icon">ğŸ“Š</div><div class="s-num" id="dstat-prom">S/0</div><div class="s-lbl">Promedio</div></div>
    </div>
    <div id="alert-diezmo" class="alert alert-success"></div>
    <div class="form-section">
      <h3>Registrar Diezmo</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Domingo</label>
          <div style="display:grid;grid-template-columns:1fr 1.2fr 1fr;gap:4px;">
            <select id="d-dia" onchange="dUpdFecha()">
              <option value="">DÃ­a</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              <option>11</option><option>12</option><option>13</option><option>14</option><option>15</option>
              <option>16</option><option>17</option><option>18</option><option>19</option><option>20</option>
              <option>21</option><option>22</option><option>23</option><option>24</option><option>25</option>
              <option>26</option><option>27</option><option>28</option><option>29</option><option>30</option>
              <option>31</option>
            </select>
            <select id="d-mes" onchange="dUpdFecha()">
              <option value="">Mes</option>
              <option value="01">Ene</option><option value="02">Feb</option><option value="03">Mar</option>
              <option value="04">Abr</option><option value="05">May</option><option value="06">Jun</option>
              <option value="07">Jul</option><option value="08">Ago</option><option value="09">Sep</option>
              <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dic</option>
            </select>
            <select id="d-ano" onchange="dUpdFecha()">
              <option value="2026">2026</option><option value="2025">2025</option>
            </select>
          </div>
          <input type="hidden" id="d-fecha">
          <div id="d-fecha-lbl" style="margin-top:3px;font-size:0.78rem;color:var(--gold-light);min-height:14px;"></div>
        </div>
        <div class="form-group">
          <label>Miembro que Diezma</label>
          <select id="d-miembro"><option value="">-- Seleccionar --</option></select>
        </div>
        <div class="form-group">
          <label>Monto (S/)</label>
          <input type="number" id="d-monto" placeholder="0.00" min="0" step="0.01" inputmode="decimal">
        </div>
        <div class="form-group">
          <label>EcÃ³nomo Registrador</label>
          <select id="d-ecÃ³nomo"><option value="">-- Seleccionar --</option></select>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:0;">
        <label>ObservaciÃ³n (opcional)</label>
        <input type="text" id="d-obs" placeholder="Notas adicionales...">
      </div>
      <div class="actions">
        <button class="btn btn-gold" onclick="guardarDiezmo()">ğŸ’° Registrar</button>
        <button class="btn btn-outline" onclick="limpiarFormDiezmo()">âœ• Limpiar</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â• TAB: HISTORIAL â•â•â•â• -->
  <div id="dtab-historial" style="display:none;">
    <div style="font-family:'Cinzel',serif;font-size:0.74rem;color:var(--gold);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;">ğŸ“… Diezmos por Domingo</div>
    <div class="filtros-bar">
      <select id="filtro-domingo" onchange="filtrarDiezmos()"><option value="">â€” Todos los domingos â€”</option></select>
      <select id="filtro-economo-d" onchange="filtrarDiezmos()"><option value="">Todos los ecÃ³nomos</option></select>
      <button class="btn btn-outline btn-sm" onclick="document.getElementById('filtro-domingo').value='';filtrarDiezmos();">â†© Todos</button>
    </div>
    <div class="table-wrap">
      <div id="diezmos-view-domingos">
        <div style="padding:8px 12px;background:rgba(201,168,76,0.05);border-bottom:1px solid var(--border);font-family:'Cinzel',serif;font-size:0.66rem;color:rgba(201,168,76,0.6);letter-spacing:1px;">Seleccione un domingo para ver sus diezmadores</div>
        <div class="table-scroll">
          <table>
            <thead><tr><th>Domingo</th><th>Diezmadores</th><th>Total</th><th></th></tr></thead>
            <tbody id="tabla-domingos-diezmos"></tbody>
          </table>
        </div>
      </div>
      <div id="diezmos-view-detalle" style="display:none;">
        <div style="padding:9px 12px;background:rgba(201,168,76,0.08);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">
          <span id="diezmos-detalle-titulo" style="font-family:'Cinzel',serif;font-size:0.82rem;color:var(--gold-light);"></span>
          <button class="btn btn-outline btn-sm" onclick="document.getElementById('filtro-domingo').value='';filtrarDiezmos();">â† Volver</button>
        </div>
        <div class="table-scroll">
          <table>
            <thead><tr><th>#</th><th>Miembro</th><th>Monto</th><th>EcÃ³nomo</th><th>Obs.</th><th></th></tr></thead>
            <tbody id="tabla-diezmos"></tbody>
          </table>
        </div>
      </div>
      <div class="tbl-footer">
        <span>DIEZMADORES: <strong id="total-diezmadores">0</strong></span>
        <span>TOTAL: <strong id="total-diezmos">S/ 0.00</strong></span>
      </div>
    </div>

    <!-- â”€â”€ BUSCAR DIEZMADOR (dentro del historial) â”€â”€ -->
    <div style="margin-top:6px;">
      <div style="font-family:'Cinzel',serif;font-size:0.74rem;color:var(--gold);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;">ğŸ” Buscar Diezmador por Nombre</div>
      <div class="search-panel" style="margin-bottom:0;">
        <div class="search-fields">
          <div class="form-group">
            <label>Nombre del diezmador</label>
            <input type="text" id="buscar-nombre" placeholder="Ej: Orlando, Wesly, Herrera..."
                   oninput="buscarDiezmador()" autocomplete="off" autocorrect="off" spellcheck="false">
          </div>
          <div class="form-group">
            <label>AÃ±o</label>
            <select id="buscar-ano" onchange="buscarDiezmador()">
              <option value="">Todos</option>
              <option value="2026">2026</option><option value="2025">2025</option>
            </select>
          </div>
          <div class="form-group">
            <label>Mes</label>
            <select id="buscar-mes" onchange="buscarDiezmador()">
              <option value="">Todos</option>
              <option value="01">Enero</option><option value="02">Febrero</option><option value="03">Marzo</option>
              <option value="04">Abril</option><option value="05">Mayo</option><option value="06">Junio</option>
              <option value="07">Julio</option><option value="08">Agosto</option><option value="09">Septiembre</option>
              <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
            </select>
          </div>
          <div class="form-group" style="justify-content:flex-end;">
            <button class="btn btn-outline btn-sm" onclick="limpiarBusqueda()" style="width:100%;">âœ• Limpiar</button>
          </div>
        </div>
        <div id="buscar-sugerencias" style="display:none;"></div>
      </div>

      <!-- Resultado persona -->
      <div id="buscar-resultado" style="display:none;margin-top:12px;">
        <div style="background:var(--navy-light);border:1px solid var(--gold);border-radius:8px;padding:14px 16px;margin-bottom:12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
          <div style="font-size:30px;">ğŸ‘¤</div>
          <div style="flex:1;min-width:130px;">
            <div id="buscar-nombre-display" style="font-family:'Cinzel',serif;font-size:clamp(0.92rem,3vw,1.05rem);color:var(--gold-light);"></div>
            <div id="buscar-tipo-display" style="font-size:0.74rem;color:rgba(201,168,76,0.55);margin-top:2px;"></div>
          </div>
          <div style="display:flex;gap:14px;flex-wrap:wrap;">
            <div style="text-align:center;">
              <div id="buscar-total-display" style="font-family:'Cinzel',serif;font-size:clamp(1rem,3vw,1.25rem);color:var(--gold);">S/0</div>
              <div style="font-size:0.58rem;color:rgba(201,168,76,0.5);text-transform:uppercase;letter-spacing:1px;">Total</div>
            </div>
            <div style="text-align:center;">
              <div id="buscar-veces-display" style="font-family:'Cinzel',serif;font-size:clamp(1rem,3vw,1.25rem);color:var(--gold-light);">0</div>
              <div style="font-size:0.58rem;color:rgba(201,168,76,0.5);text-transform:uppercase;letter-spacing:1px;">Diezmos</div>
            </div>
          </div>
        </div>
        <div class="table-wrap">
          <div class="table-header">
            <h3>Historial del Diezmador</h3>
            <span id="buscar-periodo-display" style="font-size:0.72rem;color:rgba(201,168,76,0.55);font-family:'Cinzel',serif;"></span>
          </div>
          <div class="table-scroll">
            <table>
              <thead><tr><th>#</th><th>Fecha</th><th>Monto</th><th>EcÃ³nomo</th><th>ObservaciÃ³n</th></tr></thead>
              <tbody id="buscar-tbody"></tbody>
            </table>
          </div>
          <div class="tbl-footer">
            <span>REGISTROS: <strong id="buscar-count">0</strong></span>
            <span>TOTAL: <strong id="buscar-total-footer">S/ 0.00</strong></span>
          </div>
        </div>
      </div>

      <div id="buscar-vacio" style="display:none;"></div>
      <div id="buscar-sin-resultados" style="display:none;text-align:center;padding:24px;color:rgba(201,168,76,0.3);">
        <div style="font-size:36px;margin-bottom:8px;">ğŸ˜”</div>
        <div style="font-family:'Cinzel',serif;font-size:0.8rem;letter-spacing:1px;">Sin resultados para esa bÃºsqueda</div>
      </div>
    </div>

  </div>

  <!-- â•â•â•â• TAB: RANKING â•â•â•â• -->
  <div id="dtab-ranking" style="display:none;">
    <div class="form-section">
      <h3>Filtrar PerÃ­odo</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Mes</label>
          <select id="rank-mes" onchange="renderRankingDiezmos()">
            <option value="">Todos</option>
            <option value="01">Enero</option><option value="02">Febrero</option><option value="03">Marzo</option>
            <option value="04">Abril</option><option value="05">Mayo</option><option value="06">Junio</option>
            <option value="07">Julio</option><option value="08">Agosto</option><option value="09">Septiembre</option>
            <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
          </select>
        </div>
        <div class="form-group">
          <label>AÃ±o</label>
          <select id="rank-anno" onchange="renderRankingDiezmos()">
            <option value="2026">2026</option><option value="2025">2025</option>
          </select>
        </div>
      </div>
    </div>
    <div class="ranking-grid">
      <div class="table-wrap">
        <div class="table-header"><h3>ğŸ¥‡ Mayor Aporte (S/)</h3></div>
        <div id="ranking-monto-d"></div>
      </div>
      <div class="table-wrap">
        <div class="table-header"><h3>ğŸ… Mayor Frecuencia</h3></div>
        <div id="ranking-frec-d"></div>
      </div>
    </div>
  </div>



<style>
/* Tab verde para Registrar */
.btn-tab-green {
  background: linear-gradient(135deg,#1a7a40,#1A6B3C);
  border: 2px solid #2aab5a; color: #fff;
  padding: 10px 16px; border-radius: 6px;
  cursor: pointer; font-family: 'Cinzel', serif;
  font-size: 0.8rem; letter-spacing: 1px;
  transition: all 0.2s; box-shadow: 0 2px 12px rgba(26,107,60,0.4);
  touch-action: manipulation; white-space: nowrap;
}
.btn-tab-green.btn-outline {
  background: transparent; border: 1px solid var(--gold); color: var(--gold);
  box-shadow: none;
}
</style>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const USUARIOS = [
  { user: 'admin',      pass: '1234',       nombre: 'Administrador' },
  { user: 'pastor',     pass: 'pastor2026', nombre: 'Pastor'        },
  { user: 'secretario', pass: 'sec2026',    nombre: 'Secretario'    }
];

function doLogin() {
  const u = document.getElementById('login-user').value.trim().toLowerCase();
  const p = document.getElementById('login-pass').value;
  const found = USUARIOS.find(x => x.user === u && x.pass === p);
  if (found) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('user-name').textContent = found.nombre;
    inicializar();
  } else {
    const err = document.getElementById('login-error');
    err.style.display = 'block';
    setTimeout(() => { err.style.display = 'none'; }, 3000);
    document.getElementById('login-pass').value = '';
  }
}

function cerrarSesion() {
  if (!confirm('Â¿Desea cerrar sesiÃ³n?')) return;
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-screen').style.display = 'flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DATA STORE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let DB = { miembros: [], cargos: [], diezmos: [], nextId: { m:1, c:1, d:1 } };

function seedData() {
  const personas = [
    { nombres:'Segundo Jorge', apellidos:'Mejia Nnnn',        tipo_miembro:'activo'   },
    { nombres:'Orlando',       apellidos:'Diaz Sanches',       tipo_miembro:'activo'   },
    { nombres:'Jorge',         apellidos:'Herrera Chavil',     tipo_miembro:'activo'   },
    { nombres:'Wesly',         apellidos:'Cubas Chavil',       tipo_miembro:'activo'   },
    { nombres:'Felix',         apellidos:'Herrera Chavil',     tipo_miembro:'activo'   },
    { nombres:'Adelmo',        apellidos:'Diaz Ruiz',          tipo_miembro:'activo'   },
    { nombres:'Armando',       apellidos:'Ruiz Ruiz',          tipo_miembro:'activo'   },
    { nombres:'Audino',        apellidos:'Saavedra Vera',      tipo_miembro:'activo'   },
    { nombres:'IsmeÃ±a',        apellidos:'Saavedra Vera',      tipo_miembro:'activo'   },
    { nombres:'Terry',         apellidos:'Manayay Manayay',    tipo_miembro:'activo'   },
    { nombres:'Edilverto',     apellidos:'Cubas Caruajulca',   tipo_miembro:'activo'   },
    { nombres:'Toledito',      apellidos:'Carranza Carranza',  tipo_miembro:'visitante'},
  ];
  personas.forEach(p => { p.id = DB.nextId.m++; DB.miembros.push(p); });

  [
    { id_persona:4, nombre_cargo:'EcÃ³nomo', ministerio:'Iglesia', periodo:'2024 - 2026', anio:'2026', origen:'manual' },
    { id_persona:5, nombre_cargo:'EcÃ³nomo', ministerio:'Iglesia', periodo:'2024 - 2026', anio:'2026', origen:'manual' },
  ].forEach(c => { c.id = DB.nextId.c++; DB.cargos.push(c); });

  ['2026-01-04','2026-01-11','2026-01-18','2026-01-25','2026-02-01','2026-02-08'].forEach((f, fi) => {
    [1,2,3,4,5,6].forEach((mid, di) => {
      DB.diezmos.push({ id: DB.nextId.d++, fecha: f, id_persona: mid, id_economos: 4, monto: 20+(di*5)+(fi*3), obs:'' });
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _MESES   = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
const _MESES_C = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

function fechaLarga(iso) {
  if (!iso || iso === 'â€”') return 'â€”';
  const [y, m, d] = iso.split('-');
  return `${parseInt(d)} de ${_MESES[parseInt(m)-1]} de ${y}`;
}

function showAlert(id, msg, isError = false) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.className = 'alert ' + (isError ? 'alert-error' : 'alert-success');
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 3000);
}

function nombreCompleto(id) {
  const p = DB.miembros.find(m => m.id === id);
  return p ? p.nombres + ' ' + p.apellidos : 'N/A';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showEconTab(tab) {
  ['diezmos','historial','ranking'].forEach(t => {
    const el  = document.getElementById('dtab-' + t);
    const btn = document.getElementById('dtab-btn-' + t);
    if (el)  el.style.display = t === tab ? 'block' : 'none';
    if (btn) {
      if (t === 'diezmos') {
        btn.className = tab === 'diezmos' ? 'btn-tab-green' : 'btn-tab-green btn-outline';
      } else {
        btn.className = t === tab ? 'btn btn-gold' : 'btn btn-outline';
      }
    }
  });
  if (tab === 'diezmos')   actualizarStatsDiezmos();
  if (tab === 'historial') { renderDiezmos(); actualizarFiltroDomingos(); }
  if (tab === 'ranking')   renderRankingDiezmos();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FECHA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dUpdFecha() {
  const d  = document.getElementById('d-dia')?.value;
  const m  = document.getElementById('d-mes')?.value;
  const y  = document.getElementById('d-ano')?.value || '2026';
  const hi = document.getElementById('d-fecha');
  const lb = document.getElementById('d-fecha-lbl');
  if (d && m) {
    const iso = y+'-'+m+'-'+String(d).padStart(2,'0');
    if (hi) hi.value = iso;
    if (lb) lb.textContent = fechaLarga(iso);
  } else { if(hi) hi.value=''; if(lb) lb.textContent=''; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ECÃ“NOMOS CRUD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEconLista() {
  const cont     = document.getElementById('econ-lista-cards');
  const crudCont = document.getElementById('econ-crud-lista');
  if (!cont) return;

  const econCargos = DB.cargos.filter(c => c.nombre_cargo === 'EcÃ³nomo');

  if (!econCargos.length) {
    cont.innerHTML = `<span style="color:rgba(201,168,76,0.4);font-style:italic;font-size:0.85rem;">Sin ecÃ³nomos registrados</span>`;
  } else {
    const anioActual = String(new Date().getFullYear());
    const actuales   = econCargos.filter(c => !c.anio || String(c.anio) === anioActual);
    const mostrar    = actuales.length ? actuales : econCargos;
    cont.innerHTML   = mostrar.map(c => {
      const m = DB.miembros.find(x => x.id === c.id_persona);
      if (!m) return '';
      return `<span style="background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.4);border-radius:20px;padding:5px 12px;font-family:'Cinzel',serif;font-size:0.72rem;color:var(--gold-light);">ğŸª™ ${m.nombres} ${m.apellidos}</span>`;
    }).join('');
  }

  if (!crudCont) return;
  if (!econCargos.length) {
    crudCont.innerHTML = `<div style="color:rgba(201,168,76,0.4);font-style:italic;font-size:0.82rem;padding:6px;">Ninguno aÃºn.</div>`;
    return;
  }
  const porAnio = {};
  econCargos.forEach(c => { const a = c.anio||'â€”'; if(!porAnio[a]) porAnio[a]=[]; porAnio[a].push(c); });
  crudCont.innerHTML = Object.entries(porAnio).sort((a,b)=>b[0]-a[0]).map(([anio, cargos]) =>
    `<div style="margin-bottom:8px;">
      <div style="font-size:0.66rem;color:rgba(201,168,76,0.5);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">ğŸ“… AÃ±o ${anio}</div>
      ${cargos.map(c => {
        const m = DB.miembros.find(x => x.id === c.id_persona);
        if (!m) return '';
        return `<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:rgba(201,168,76,0.05);border:1px solid rgba(201,168,76,0.15);border-radius:6px;margin-bottom:4px;">
          <span style="flex:1;font-size:0.85rem;color:var(--cream);">${m.nombres} ${m.apellidos}
            <span style="font-size:0.7rem;color:rgba(201,168,76,0.5);">${c.periodo||''}</span>
          </span>
          <button class="btn btn-outline btn-sm" onclick="editarEconomo(${c.id})">âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="eliminarEconomo(${c.id})">âœ•</button>
        </div>`;
      }).join('')}
    </div>`
  ).join('');
}

function togglePanelEconomo() {
  const panel = document.getElementById('form-economo-panel');
  if (!panel) return;
  const show = panel.style.display === 'none';
  panel.style.display = show ? 'block' : 'none';
  if (show) { renderEconLista(); poblarSelectEconomo(); }
}

function poblarSelectEconomo() {
  const sel = document.getElementById('econ-add-persona');
  if (!sel) return;
  sel.innerHTML = '<option value="">-- Seleccionar --</option>';
  DB.miembros.filter(m => m.tipo_miembro !== 'no_activo').forEach(m => {
    sel.innerHTML += `<option value="${m.id}">${m.nombres} ${m.apellidos}</option>`;
  });
}

function editarEconomo(id) {
  const c = DB.cargos.find(x => x.id === id);
  if (!c) return;
  document.getElementById('econ-edit-id').value = id;
  const tit = document.getElementById('form-economo-titulo'); if(tit) tit.textContent = 'Editando ecÃ³nomo';
  poblarSelectEconomo();
  const sel = document.getElementById('econ-add-persona'); if(sel) sel.value = c.id_persona;
  const ano = document.getElementById('econ-add-ano');     if(ano) ano.value = c.anio || new Date().getFullYear();
  const per = document.getElementById('econ-add-periodo'); if(per) per.value = c.periodo || '';
}

function limpiarFormEconomo() {
  document.getElementById('econ-edit-id').value = '';
  const tit = document.getElementById('form-economo-titulo'); if(tit) tit.textContent = 'Nuevo EcÃ³nomo';
  poblarSelectEconomo();
  const per = document.getElementById('econ-add-periodo'); if(per) per.value = '';
}

function guardarEconomo() {
  const id_p    = parseInt(document.getElementById('econ-add-persona')?.value);
  const periodo = document.getElementById('econ-add-periodo')?.value.trim() || '';
  const anio    = document.getElementById('econ-add-ano')?.value || String(new Date().getFullYear());
  const editId  = parseInt(document.getElementById('econ-edit-id')?.value) || 0;
  if (!id_p) { showAlert('alert-economo-form','âš  Seleccione una persona', true); return; }
  if (editId) {
    const cargo = DB.cargos.find(c => c.id === editId);
    if (cargo) { cargo.id_persona = id_p; cargo.periodo = periodo; cargo.anio = anio; }
    showAlert('alert-economo-form','âœ“ EcÃ³nomo actualizado');
  } else {
    DB.cargos.push({ id: DB.nextId.c++, id_persona: id_p, nombre_cargo: 'EcÃ³nomo', ministerio: 'Iglesia', periodo, anio, origen: 'manual' });
    showAlert('alert-economo-form','âœ“ EcÃ³nomo registrado');
  }
  limpiarFormEconomo(); renderEconLista(); refreshSelects();
}

function eliminarEconomo(id) {
  const cargo = DB.cargos.find(c => c.id === id);
  const m = cargo ? DB.miembros.find(x => x.id === cargo.id_persona) : null;
  if (!confirm(`Â¿Eliminar a ${m ? m.nombres+' '+m.apellidos : 'este ecÃ³nomo'} como EcÃ³nomo?`)) return;
  DB.cargos = DB.cargos.filter(c => c.id !== id);
  renderEconLista(); refreshSelects();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REFRESH SELECTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshSelects() {
  const selMiem = document.getElementById('d-miembro');
  if (selMiem) {
    const val = selMiem.value;
    selMiem.innerHTML = '<option value="">-- Seleccionar --</option>';
    DB.miembros.filter(m => m.tipo_miembro !== 'no_activo').forEach(m => {
      selMiem.innerHTML += `<option value="${m.id}" ${m.id==val?'selected':''}>${m.nombres} ${m.apellidos}</option>`;
    });
  }
  const ecSel = document.getElementById('d-ecÃ³nomo');
  if (ecSel) {
    const economs = DB.cargos.filter(c => c.nombre_cargo === 'EcÃ³nomo').map(c => c.id_persona);
    ecSel.innerHTML = '<option value="">-- Seleccionar EcÃ³nomo --</option>';
    const lista = economs.length ? DB.miembros.filter(m => economs.includes(m.id)) : DB.miembros.filter(m => m.tipo_miembro !== 'no_activo');
    lista.forEach(m => { ecSel.innerHTML += `<option value="${m.id}">${m.nombres} ${m.apellidos}</option>`; });
  }
  poblarSelectEconomo();
  actualizarFiltroDomingos();
  actualizarStatsDiezmos();
  renderEconLista();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REGISTRAR DIEZMO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function guardarDiezmo() {
  dUpdFecha();
  const fecha = document.getElementById('d-fecha').value;
  const id_p  = parseInt(document.getElementById('d-miembro').value);
  const monto = parseFloat(document.getElementById('d-monto').value);
  const id_ec = parseInt(document.getElementById('d-ecÃ³nomo').value);
  const obs   = document.getElementById('d-obs')?.value.trim() || '';
  if (!fecha)             return showAlert('alert-diezmo','âš  Seleccione una fecha', true);
  if (!id_p)              return showAlert('alert-diezmo','âš  Seleccione el miembro', true);
  if (!monto || monto<=0) return showAlert('alert-diezmo','âš  Ingrese un monto vÃ¡lido', true);
  if (!id_ec)             return showAlert('alert-diezmo','âš  Seleccione el ecÃ³nomo', true);
  if (DB.diezmos.find(d => d.fecha === fecha && d.id_persona === id_p))
    return showAlert('alert-diezmo',`âš  ${nombreCompleto(id_p)} ya tiene diezmo ese domingo`, true);
  DB.diezmos.push({ id: DB.nextId.d++, fecha, id_persona: id_p, id_economos: id_ec, monto, obs });
  showAlert('alert-diezmo','âœ“ Diezmo registrado correctamente');
  limpiarFormDiezmo();
  actualizarFiltroDomingos(); actualizarStatsDiezmos();
}

function limpiarFormDiezmo() {
  document.getElementById('d-monto').value = '';
  if (document.getElementById('d-obs')) document.getElementById('d-obs').value = '';
  document.getElementById('d-miembro').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HISTORIAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDiezmos() {
  const filtroDom = document.getElementById('filtro-domingo')?.value  || '';
  const filtroEc  = parseInt(document.getElementById('filtro-economo-d')?.value) || 0;
  const vD  = document.getElementById('diezmos-view-domingos');
  const vDe = document.getElementById('diezmos-view-detalle');

  if (!filtroDom) {
    if (vD)  vD.style.display  = 'block';
    if (vDe) vDe.style.display = 'none';
    const domingos = {};
    DB.diezmos.forEach(d => {
      if (filtroEc && d.id_economos !== filtroEc) return;
      if (!domingos[d.fecha]) domingos[d.fecha] = { count:0, total:0 };
      domingos[d.fecha].count++; domingos[d.fecha].total += d.monto;
    });
    const tbody  = document.getElementById('tabla-domingos-diezmos');
    const fechas = Object.keys(domingos).sort().reverse();
    if (tbody) tbody.innerHTML = fechas.length
      ? fechas.map(f => `<tr style="cursor:pointer;" onclick="seleccionarDomingo('${f}')">
          <td><strong>${fechaLarga(f)}</strong></td>
          <td><span class="badge badge-blue">${domingos[f].count}</span></td>
          <td style="font-family:'Cinzel',serif;color:var(--gold);font-weight:bold;">S/ ${domingos[f].total.toFixed(2)}</td>
          <td><button class="btn btn-outline btn-sm" onclick="event.stopPropagation();seleccionarDomingo('${f}')">Ver â†’</button></td>
        </tr>`).join('')
      : `<tr><td colspan="4" style="text-align:center;padding:24px;color:rgba(201,168,76,0.3);font-family:'Cinzel',serif;font-size:0.76rem;">â€” Sin registros â€”</td></tr>`;
    document.getElementById('total-diezmadores').textContent = Object.values(domingos).reduce((s,d)=>s+d.count,0);
    document.getElementById('total-diezmos').textContent = 'S/ '+Object.values(domingos).reduce((s,d)=>s+d.total,0).toFixed(2);
  } else {
    if (vD)  vD.style.display  = 'none';
    if (vDe) vDe.style.display = 'block';
    const tit = document.getElementById('diezmos-detalle-titulo');
    if (tit) tit.textContent = `Diezmos del ${fechaLarga(filtroDom)}`;
    let lista = DB.diezmos.filter(d => d.fecha === filtroDom);
    if (filtroEc) lista = lista.filter(d => d.id_economos === filtroEc);
    const tbody = document.getElementById('tabla-diezmos');
    if (tbody) tbody.innerHTML = lista.map((d,i) => `<tr>
        <td><span class="badge badge-gold">${i+1}</span></td>
        <td>${nombreCompleto(d.id_persona)}</td>
        <td style="font-family:'Cinzel',serif;color:var(--gold);font-weight:bold;">S/ ${parseFloat(d.monto).toFixed(2)}</td>
        <td>${nombreCompleto(d.id_economos)}</td>
        <td style="color:rgba(245,240,232,0.45);font-size:0.82rem;">${d.obs||'â€”'}</td>
        <td><button class="btn btn-danger btn-sm" onclick="eliminarDiezmo(${d.id})">âœ•</button></td>
      </tr>`).join('') || `<tr><td colspan="6" style="text-align:center;padding:20px;color:rgba(201,168,76,.3);">â€” Sin registros â€”</td></tr>`;
    document.getElementById('total-diezmadores').textContent = lista.length;
    document.getElementById('total-diezmos').textContent = 'S/ '+lista.reduce((s,d)=>s+d.monto,0).toFixed(2);
  }
}

function seleccionarDomingo(fecha) {
  const sel = document.getElementById('filtro-domingo');
  if (sel) { sel.value = fecha; filtrarDiezmos(); }
}

function eliminarDiezmo(id) {
  if (!confirm('Â¿Eliminar este registro de diezmo?')) return;
  DB.diezmos = DB.diezmos.filter(d => d.id !== id);
  actualizarFiltroDomingos(); renderDiezmos(); actualizarStatsDiezmos();
}

function filtrarDiezmos() { renderDiezmos(); }

function actualizarStatsDiezmos() {
  const domingos = [...new Set(DB.diezmos.map(d => d.fecha))].length;
  const total    = DB.diezmos.reduce((s,d) => s+d.monto, 0);
  const prom     = DB.diezmos.length ? total/DB.diezmos.length : 0;
  const sd = document.getElementById('dstat-domingos'); if(sd) sd.textContent = domingos;
  const sc = document.getElementById('dstat-count');    if(sc) sc.textContent = DB.diezmos.length;
  const st = document.getElementById('dstat-total');    if(st) st.textContent = 'S/'+total.toFixed(0);
  const sp = document.getElementById('dstat-prom');     if(sp) sp.textContent = 'S/'+prom.toFixed(0);
}

function actualizarFiltroDomingos() {
  const fechas = [...new Set(DB.diezmos.map(d => d.fecha))].sort().reverse();
  const sel = document.getElementById('filtro-domingo');
  if (sel) {
    const val = sel.value;
    sel.innerHTML = '<option value="">â€” Todos los domingos â€”</option>';
    fechas.forEach(f => { sel.innerHTML += `<option value="${f}" ${f===val?'selected':''}>${fechaLarga(f)}</option>`; });
  }
  const selEc = document.getElementById('filtro-economo-d');
  if (selEc) {
    const valEc   = selEc.value;
    const economs = DB.cargos.filter(c => c.nombre_cargo === 'EcÃ³nomo').map(c => c.id_persona);
    selEc.innerHTML = '<option value="">Todos los ecÃ³nomos</option>';
    DB.miembros.filter(m => economs.includes(m.id)).forEach(m => {
      selEc.innerHTML += `<option value="${m.id}" ${m.id==valEc?'selected':''}>${m.nombres} ${m.apellidos}</option>`;
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RANKING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRankingDiezmos() {
  const mes  = document.getElementById('rank-mes')?.value  || '';
  const anno = document.getElementById('rank-anno')?.value || '';
  let lista  = [...DB.diezmos];
  if (anno) lista = lista.filter(d => d.fecha.startsWith(anno));
  if (mes)  lista = lista.filter(d => d.fecha.substring(5,7) === mes);

  const porPersona = {};
  lista.forEach(d => {
    if (!porPersona[d.id_persona]) porPersona[d.id_persona] = { monto:0, veces:0 };
    porPersona[d.id_persona].monto += d.monto; porPersona[d.id_persona].veces++;
  });

  const rankMonto = Object.entries(porPersona).map(([id,v])=>({id:parseInt(id),...v})).sort((a,b)=>b.monto-a.monto);
  const rankFrec  = [...rankMonto].sort((a,b)=>b.veces-a.veces);
  const posL = i => i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':(i+1);
  const colL = i => i===0?'var(--gold-light)':i===1?'#C0C0C0':i===2?'#CD7F32':'rgba(201,168,76,0.5)';
  const itemHTML = (r, i, sm) => `
    <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;border-bottom:1px solid rgba(201,168,76,0.07);">
      <span style="font-family:'Cinzel',serif;font-size:${i<3?'1rem':'0.8rem'};color:${colL(i)};width:20px;text-align:center;flex-shrink:0;">${posL(i)}</span>
      <span style="flex:1;font-size:0.85rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${nombreCompleto(r.id)}</span>
      <span style="font-size:0.72rem;color:rgba(201,168,76,0.45);margin-right:3px;">${sm ? r.veces+' vez'+(r.veces!==1?'es':'') : 'S/ '+r.monto.toFixed(2)}</span>
      <span style="font-family:'Cinzel',serif;font-size:0.85rem;color:var(--gold);flex-shrink:0;">${sm ? 'S/ '+r.monto.toFixed(2) : r.veces+' dom'+(r.veces!==1?'ingos':'ingo')}</span>
    </div>`;

  const noData = '<div style="text-align:center;padding:18px;color:rgba(201,168,76,0.3);font-family:Cinzel,serif;font-size:0.76rem;">â€” Sin datos â€”</div>';
  const rm = document.getElementById('ranking-monto-d'); if(rm) rm.innerHTML = rankMonto.length ? rankMonto.map((r,i)=>itemHTML(r,i,true)).join('')  : noData;
  const rf = document.getElementById('ranking-frec-d');  if(rf) rf.innerHTML = rankFrec.length  ? rankFrec.map((r,i) =>itemHTML(r,i,false)).join('') : noData;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUSCAR DIEZMADOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _buscarPersonaId = null;

function buscarDiezmador() {
  const query = (document.getElementById('buscar-nombre')?.value || '').toLowerCase().trim();
  const ano   = document.getElementById('buscar-ano')?.value  || '';
  const mes   = document.getElementById('buscar-mes')?.value  || '';

  const elRes    = document.getElementById('buscar-resultado');
  const elVacio  = document.getElementById('buscar-vacio');
  const elSinRes = document.getElementById('buscar-sin-resultados');
  const elSug    = document.getElementById('buscar-sugerencias');

  if (!query) {
    _buscarPersonaId = null;
    elRes.style.display    = 'none';
    elSinRes.style.display = 'none';
    elVacio.style.display  = 'block';
    elSug.style.display    = 'none';
    return;
  }

  const matches = DB.miembros.filter(m =>
    (m.nombres + ' ' + m.apellidos).toLowerCase().includes(query)
  );

  // Si hay persona ya seleccionada y sigue coincidiendo, actualizar su historial
  if (_buscarPersonaId && matches.find(m => m.id === _buscarPersonaId)) {
    elSug.style.display = 'none';
    mostrarHistorialPersona(_buscarPersonaId, ano, mes);
    return;
  }

  // Si hay un Ãºnico match directo
  if (matches.length === 1) {
    _buscarPersonaId = matches[0].id;
    elSug.style.display = 'none';
    mostrarHistorialPersona(matches[0].id, ano, mes);
    return;
  }

  // MÃºltiples matches â†’ sugerencias desplegables
  if (matches.length > 1) {
    elRes.style.display    = 'none';
    elVacio.style.display  = 'none';
    elSinRes.style.display = 'none';
    elSug.style.display    = 'block';
    elSug.innerHTML = matches.slice(0, 6).map(m => {
      const totalM = DB.diezmos.filter(d => d.id_persona === m.id).reduce((s,d)=>s+d.monto,0);
      return `<div onclick="seleccionarPersonaBusqueda(${m.id})"
        style="padding:10px 14px;cursor:pointer;border-bottom:1px solid rgba(201,168,76,0.1);display:flex;justify-content:space-between;align-items:center;background:var(--navy-light);"
        onmouseover="this.style.background='rgba(201,168,76,0.08)'" onmouseout="this.style.background='var(--navy-light)'">
        <div>
          <div style="font-size:0.9rem;color:var(--cream);">${m.nombres} ${m.apellidos}</div>
          <div style="font-size:0.68rem;color:rgba(201,168,76,0.5);text-transform:uppercase;letter-spacing:1px;margin-top:2px;">${m.tipo_miembro||''}</div>
        </div>
        <div style="font-family:'Cinzel',serif;font-size:0.82rem;color:var(--gold);">S/ ${totalM.toFixed(2)}</div>
      </div>`;
    }).join('');
    return;
  }

  // Sin matches
  _buscarPersonaId = null;
  elSug.style.display    = 'none';
  elRes.style.display    = 'none';
  elVacio.style.display  = 'none';
  elSinRes.style.display = 'block';
}

function seleccionarPersonaBusqueda(id) {
  _buscarPersonaId = id;
  const m = DB.miembros.find(x => x.id === id);
  if (m) document.getElementById('buscar-nombre').value = m.nombres + ' ' + m.apellidos;
  document.getElementById('buscar-sugerencias').style.display = 'none';
  mostrarHistorialPersona(id,
    document.getElementById('buscar-ano')?.value || '',
    document.getElementById('buscar-mes')?.value || ''
  );
}

function mostrarHistorialPersona(id, ano, mes) {
  const elRes    = document.getElementById('buscar-resultado');
  const elVacio  = document.getElementById('buscar-vacio');
  const elSinRes = document.getElementById('buscar-sin-resultados');

  const m = DB.miembros.find(x => x.id === id);
  if (!m) return;

  let lista = DB.diezmos.filter(d => d.id_persona === id);
  if (ano) lista = lista.filter(d => d.fecha.startsWith(ano));
  if (mes) lista = lista.filter(d => d.fecha.substring(5,7) === mes);
  lista.sort((a,b) => b.fecha.localeCompare(a.fecha));

  const total = lista.reduce((s,d)=>s+d.monto, 0);

  document.getElementById('buscar-nombre-display').textContent = m.nombres + ' ' + m.apellidos;
  const tipoLabel = { activo:'Miembro Activo', no_activo:'No Activo', asociado:'Asociado', visitante:'Visitante' };
  document.getElementById('buscar-tipo-display').textContent  = tipoLabel[m.tipo_miembro] || m.tipo_miembro;
  document.getElementById('buscar-total-display').textContent = 'S/ '+total.toFixed(2);
  document.getElementById('buscar-veces-display').textContent = lista.length;

  const elPer = document.getElementById('buscar-periodo-display');
  if (elPer) {
    let per = '';
    if (ano && mes) per = `${_MESES_C[parseInt(mes)-1]} ${ano}`;
    else if (ano)   per = `AÃ±o ${ano}`;
    else if (mes)   per = _MESES_C[parseInt(mes)-1];
    else            per = 'Todos los perÃ­odos';
    elPer.textContent = per;
  }

  const tbody = document.getElementById('buscar-tbody');
  if (tbody) {
    tbody.innerHTML = lista.length
      ? lista.map((d,i) => `<tr>
          <td><span class="badge badge-gold">${i+1}</span></td>
          <td>${fechaLarga(d.fecha)}</td>
          <td style="font-family:'Cinzel',serif;color:var(--gold);font-weight:bold;">S/ ${parseFloat(d.monto).toFixed(2)}</td>
          <td>${nombreCompleto(d.id_economos)}</td>
          <td style="color:rgba(245,240,232,0.45);font-size:0.8rem;">${d.obs||'â€”'}</td>
        </tr>`).join('')
      : `<tr><td colspan="5" style="text-align:center;padding:24px;color:rgba(201,168,76,0.3);font-family:'Cinzel',serif;font-size:0.76rem;">â€” Sin registros para este perÃ­odo â€”</td></tr>`;
  }

  elRes.style.display    = 'block';
  elVacio.style.display  = 'none';
  elSinRes.style.display = 'none';

  document.getElementById('buscar-count').textContent        = lista.length;
  document.getElementById('buscar-total-footer').textContent = 'S/ '+total.toFixed(2);
}

function limpiarBusqueda() {
  _buscarPersonaId = null;
  ['buscar-nombre','buscar-ano','buscar-mes'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value = '';
  });
  document.getElementById('buscar-sugerencias').style.display    = 'none';
  document.getElementById('buscar-resultado').style.display      = 'none';
  document.getElementById('buscar-sin-resultados').style.display = 'none';
  document.getElementById('buscar-vacio').style.display          = 'block';
}

// Cerrar sugerencias al tocar fuera
document.addEventListener('click', e => {
  const sug = document.getElementById('buscar-sugerencias');
  const inp = document.getElementById('buscar-nombre');
  if (sug && inp && !sug.contains(e.target) && e.target !== inp)
    sug.style.display = 'none';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function inicializar() {
  refreshSelects();
  renderEconLista();
  showEconTab('historial');
  const t  = new Date().toISOString().split('T')[0].split('-');
  const dd = document.getElementById('d-dia'); if(dd) dd.value = parseInt(t[2]);
  const dm = document.getElementById('d-mes'); if(dm) dm.value = t[1];
  dUpdFecha();
}

seedData();
</script>
</body>
</html>
